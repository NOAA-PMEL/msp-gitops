apiVersion: serving.knative.dev/v1
kind: Service
metadata:
  name: kn-mqtt-adapter
spec:
  template:
    metadata:
      # labels:
      #   app: kn-mqtt-adapter
      annotations:
        autoscaling.knative.dev/min-scale: "1"
        autoscaling.knative.dev/max-scale: "3"
        autoscaling.knative.dev/target: "10"
        autoscaling.knative.dev/target-utilization-percentage: "70"
    spec:
      imagePullSecrets:
      - name: ghcr-ro-secret
      containers:
      # - name: kn-mqtt-adapter
      - image: ghcr.io/noaa-pmel/msp/kn-mqtt-adapter:0.1.6
        imagePullPolicy: "Always"
        env:
          - name: KN_MQTT_MQTT_BROKER
            valueFrom:
              configMapKeyRef:
                name: kn-mqtt-adapter
                key: mqtt_broker
          - name: KN_MQTT_MQTT_PORT
            valueFrom:
              configMapKeyRef:
                name: kn-mqtt-adapter
                key: mqtt_port
          - name: KN_MQTT_MQTT_TOPIC_SUBSCRIPTIONS
            valueFrom:
              configMapKeyRef:
                name: kn-mqtt-adapter
                key: mqtt_topic_subscriptions
          - name: KN_MQTT_KNATIVE_BROKER
            valueFrom:
              configMapKeyRef:
                name: kn-mqtt-adapter
                key: knative_broker
        # resources:
        #   requests:
        #     cpu: "200m"
        #   limits:
        #     memory: "1Gi"
        #     cpu: "1000m"
        ports:
          - containerPort: 8080
        # - name: http
        #   containerPort: 8080
        #   protocol: TCP